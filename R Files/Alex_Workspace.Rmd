---
title: "FM_Housing Workspace - Jake"
author: "Alex Voigt & Jake Peters"
date: "6/4/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readxl)
library(lubridate)
```


```{r}
FM_Housing_Raw <- read_csv(unz("../Data/FM_Housing_Raw.zip", "FM_Housing_Raw.csv"), col_types = cols(
  `Lease Term` = col_character(),
  `Directions` = col_character(),
  `Water Frontage Length` = col_integer()
))

FM_Labor_Raw <- read_excel("../Data/FM_Labor_Raw.xlsx")
```

```{r}
FM_Housing_Clean <- FM_Housing_Raw %>% select(-c("Property Type", "Card Format")) #All properties are Residential for both Property Type and Card Format variables
FM_Housing_Clean <- FM_Housing_Clean %>% select(-c("List Number", "Directions")) #Arbitrary values not useful for data mining
FM_Housing_Clean$`Year Built`[FM_Housing_Clean$`Year Built` < 1600 | FM_Housing_Clean$`Year Built` > 2021] <- NA
FM_Housing_Clean <- FM_Housing_Clean %>% mutate("List Price Change":=`List Price`-`Original List Price`)
FM_Housing_Clean <- FM_Housing_Clean %>% mutate("Sold/List Price Difference":=`Sold Price` - `List Price`)
FM_Housing_Clean <- FM_Housing_Clean %>% mutate("Sold/Original List Price Difference":=`Sold Price` - `Original List Price`)

FM_Housing_Clean <- FM_Housing_Clean %>% mutate("Sold Period" = floor_date(`Sold Date`, "month"))
```

```{r}
FM_Agg_Monthly <- FM_Labor_Raw %>% mutate(Period=as.Date(paste(Year, Period, "01", sep="-"), "%Y-%b-%d")) %>% select(-Year)

FM_Agg_Monthly <- FM_Agg_Monthly %>% mutate_at(vars(-Period), parse_number)
```

```{r}
getHousesOnMarket <- function(currentDate) {
  return(nrow(FM_Housing_Clean %>% filter(`Start Date` <= currentDate, currentDate <= `Pended Date`)))
}

getHousesSoldMonthly <- function(currentDate) {
  return(nrow(FM_Housing_Clean %>% filter(currentDate - months(1) <= `Pended Date`, `Pended Date` <= currentDate)))
}

getHousesSoldYearly <- function(currentDate) {
  return(nrow(FM_Housing_Clean %>% filter(currentDate - years(1) <= `Pended Date`, `Pended Date` <= currentDate)))
}

getMedianSoldPriceMonthly <- function(currentDate) {
  return((FM_Housing_Clean %>% filter(currentDate - months(1) <= `Pended Date`, `Pended Date` <= currentDate)) %>% pull(`Sold Price`) %>% median())
}

FM_Agg_Monthly <- FM_Agg_Monthly %>% rowwise %>% mutate("Houses on Market" = getHousesOnMarket(Period))
FM_Agg_Monthly <- FM_Agg_Monthly %>% rowwise %>% mutate("Houses Sold in Period" = getHousesSoldMonthly(Period))
FM_Agg_Monthly <- FM_Agg_Monthly %>% rowwise %>% mutate("Sales Rate over past Year" = getHousesSoldYearly(Period)/12)
FM_Agg_Monthly <- FM_Agg_Monthly %>% mutate("Months Remaining Inventory" = `Houses on Market` / `Houses Sold in Period`)
FM_Agg_Monthly <- FM_Agg_Monthly %>% mutate("Seasonally-corrected MRI" = `Houses on Market` / `Sales Rate over past Year`)
FM_Agg_Monthly <- FM_Agg_Monthly %>% mutate("Median Sold Price in Period" = getMedianSoldPriceMonthly(Period))
```

```{r}
FM_Agg_Monthly %>% filter(Period >= as.Date("2002-05-01") & Period <= as.Date("2020-01-01")) %>% ggplot() + geom_line(mapping=aes(x=Period, y=`Houses on Market`), color="red") + geom_line(mapping=aes(x=Period, y=`Houses Sold in Period`), colour="blue")

FM_Agg_Monthly %>% filter(Period >= as.Date("2002-05-01") & Period <= as.Date("2020-01-01")) %>% ggplot() + geom_line(mapping=aes(x=Period, y=`Months Remaining Inventory`))

FM_Agg_Monthly %>% filter(Period >= as.Date("2002-05-01") & Period <= as.Date("2020-01-01")) %>% ggplot() + geom_line(mapping=aes(x=Period, y=`Seasonally-corrected MRI`))

FM_Agg_Monthly %>% filter(Period >= as.Date("2002-05-01") & Period <= as.Date("2020-01-01")) %>% ggplot() + geom_line(mapping=aes(x=Period, y=`Median Sold Price in Period`))
```

